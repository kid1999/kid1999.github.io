<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Solidity基础 | Kid1999' Blog</title><meta name="description" content="Solidity基础"><meta name="keywords" content="Solidity"><meta name="author" content="kid1999"><meta name="copyright" content="kid1999"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="google-site-verification=1QTg0QaNHFPMhpyEbi6sCIR6Po-bAsEjy0UCeBQ90Nc"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Solidity基础"><meta name="twitter:description" content="Solidity基础"><meta name="twitter:image" content="https://ae01.alicdn.com/kf/H578cfe19a3854a09ae91991ec2f13f7ey.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Solidity基础"><meta property="og:url" content="http://kid1999.github.io/2021/06/20/Solidity%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="Kid1999' Blog"><meta property="og:description" content="Solidity基础"><meta property="og:image" content="https://ae01.alicdn.com/kf/H578cfe19a3854a09ae91991ec2f13f7ey.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://kid1999.github.io/2021/06/20/Solidity%E5%9F%BA%E7%A1%80/"><link rel="prev" title="Fabric基础" href="http://kid1999.github.io/2021/06/21/Fabric%E5%9F%BA%E7%A1%80/"><link rel="next" title="区块链基础" href="http://kid1999.github.io/2021/06/18/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%9F%BA%E7%A1%80/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://kid1999.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: {"text":"富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善","fontSize":"15px"},
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Kid1999' Blog</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="https://ae01.alicdn.com/kf/H340f46b2cafd47248f643b32d3629cc3d.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">68</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">71</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#一个Solidity智能合约的定义："><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">一个Solidity智能合约的定义：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#一个简单的Solidity智能合约的构成："><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">一个简单的Solidity智能合约的构成：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#简单代码的编写调试运行："><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">简单代码的编写调试运行：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#智能合约的生命周期："><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">智能合约的生命周期：</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#比如下述代码的运行流程："><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">比如下述代码的运行流程：</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#EVM原理"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">EVM原理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#存储深究"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">存储深究</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#总结："><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">总结：</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一个Solidity智能合约的定义："><span class="toc-number">1.</span> <span class="toc-text">一个Solidity智能合约的定义：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一个简单的Solidity智能合约的构成："><span class="toc-number">2.</span> <span class="toc-text">一个简单的Solidity智能合约的构成：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#简单代码的编写调试运行："><span class="toc-number">3.</span> <span class="toc-text">简单代码的编写调试运行：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#智能合约的生命周期："><span class="toc-number">4.</span> <span class="toc-text">智能合约的生命周期：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#比如下述代码的运行流程："><span class="toc-number">4.1.</span> <span class="toc-text">比如下述代码的运行流程：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EVM原理"><span class="toc-number">5.</span> <span class="toc-text">EVM原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储深究"><span class="toc-number">6.</span> <span class="toc-text">存储深究</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结："><span class="toc-number">7.</span> <span class="toc-text">总结：</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ae01.alicdn.com/kf/H578cfe19a3854a09ae91991ec2f13f7ey.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Solidity基础</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-06-20<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-06-20</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">区块链</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon" aria-hidden="true"></i><span>字数总计: </span><span class="word-count">2.3k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon" aria-hidden="true"></i><span>阅读时长: 7 分钟</span><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h3 id="一个Solidity智能合约的定义："><a href="#一个Solidity智能合约的定义：" class="headerlink" title="一个Solidity智能合约的定义："></a>一个Solidity智能合约的定义：</h3><blockquote>
<p>运行在区块链上的一个服务，代码可见，大家都可以调用执行其中的方法，完成信息读写，转账等功能。</p>
</blockquote>
<h3 id="一个简单的Solidity智能合约的构成："><a href="#一个简单的Solidity智能合约的构成：" class="headerlink" title="一个简单的Solidity智能合约的构成："></a>一个简单的Solidity智能合约的构成：</h3><blockquote>
<p>其语法类似 JS，也是运行在虚拟机上的。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.1</span>;		<span class="comment">// EVM编译器版本</span></span><br><span class="line"></span><br><span class="line">contract MyContract&#123;		<span class="comment">// 一个合约 类比Java中的一个类</span></span><br><span class="line">    string value;   		<span class="comment">// 定义一个变量，默认保存在区块链上</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">constructor</span>() public&#123;	<span class="comment">// 初始化函数</span></span><br><span class="line">        value = <span class="string">"MyContract"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">// 一个get方法</span></span><br><span class="line">    <span class="comment">// public说明这个一个公开可调用的方法</span></span><br><span class="line">    <span class="comment">// view说明这个方法只读不可写</span></span><br><span class="line">    <span class="comment">// returns说明这个函数的回传值类型</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">string memory</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重点在memory关键字 说明这个变量只存在于内存中，不保存于区块链中</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">string memory _value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        value = _value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是智能合约中各个变量的生命周期由关键字把握，由于每一步操作都是会消耗gas的，所以尽量要求操作简单直接，不要出现多余的浪费。</p>
<h3 id="简单代码的编写调试运行："><a href="#简单代码的编写调试运行：" class="headerlink" title="简单代码的编写调试运行："></a>简单代码的编写调试运行：</h3><blockquote>
<p> 本文使用的<a href="http://remix.app.hubwiz.com/#optimize=false&runs=200&evmVersion=null&version=soljson-v0.5.17+commit.d19bba13.js" target="_blank" rel="noopener">Remix</a>直接编写运行，Remix提供各个版本的编译环境和模拟区块链环境提供账户以供测试。</p>
</blockquote>
<ol>
<li><strong>编写代码</strong></li>
</ol>
<p><img alt data-src="https://pic.imgdb.cn/item/60ceb37d844ef46bb2a5bb77.jpg" class="lazyload"></p>
<ol start="2">
<li><strong>编译</strong></li>
</ol>
<p><img alt data-src="https://pic.imgdb.cn/item/60ceb40d844ef46bb2a9ebdd.jpg" class="lazyload"></p>
<ol start="3">
<li><strong>部署</strong></li>
</ol>
<p><img alt="image-20210620112330856" data-src="https://i.loli.net/2021/06/20/Yl1RnFqAUP67oI3.png" class="lazyload"></p>
<p>当用户调用set方法时：</p>
<p><img alt data-src="https://pic.imgdb.cn/item/60ced128844ef46bb28855d7.jpg" class="lazyload"></p>
<p>调用get方法时：</p>
<p><img alt data-src="https://pic.imgdb.cn/item/60ced1fa844ef46bb28f41c9.jpg" class="lazyload"></p>
<h3 id="智能合约的生命周期："><a href="#智能合约的生命周期：" class="headerlink" title="智能合约的生命周期："></a>智能合约的生命周期：</h3><p>Solidity 的代码生命周期离不开编译、部署、执行、销毁这四个阶段。</p>
<p><img alt="img" data-src="https://static001.infoq.cn/resource/image/5f/8e/5f35e9b2fdf59b8668acc1af1ae8b58e.jpg" class="lazyload"></p>
<p>经编译后，Solidity 文件会生成字节码。这是一种类似 jvm 字节码的代码。部署时，字节码与构造参数会被构建成交易，这笔交易会被打包到区块中，经由网络共识过程，最后在各区块链节点上构建合约，并将合约地址返还用户。</p>
<p>当用户准备调用该合约上的函数时，调用请求同样也会经历交易、区块、共识的过程，最终在各节点上由 EVM 虚拟机来执行。</p>
<h4 id="比如下述代码的运行流程："><a href="#比如下述代码的运行流程：" class="headerlink" title="比如下述代码的运行流程："></a>比如下述代码的运行流程：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.25</span>;</span><br><span class="line"></span><br><span class="line">contract Demo&#123;</span><br><span class="line">    uint private _state;</span><br><span class="line">    <span class="keyword">constructor</span>(uint state)&#123;</span><br><span class="line">        _state = state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">uint state</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        _state = state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><strong>编译</strong> </p>
<p>源代码编译完后，可以通过 ByteCode 按钮得到它的二进制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">608060405234801561001057600080fd5b506040516020806100ed83398101806040528101908080519060200190929190505050806000819055505060a4806100496000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b1146044575b600080fd5b348015604f57600080fd5b50606c60048036038101908080359060200190929190505050606e565b005b80600081905550505600a165627a7a723058204ed906444cc4c9aabd183c52b2d486dfc5dea9801260c337185dad20e11f811b0029</span><br></pre></td></tr></table></figure>

<p>还可以得到对应的字节码（OpCode）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH2 0x10 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x40 MLOAD PUSH1 0x20 DUP1 PUSH2 0xED DUP4 CODECOPY DUP2 ADD DUP1 PUSH1 0x40 MSTORE DUP2 ADD SWAP1 DUP1 DUP1 MLOAD SWAP1 PUSH1 0x20 ADD SWAP1 SWAP3 SWAP2 SWAP1 POP POP POP DUP1 PUSH1 0x0 DUP2 SWAP1 SSTORE POP POP PUSH1 0xA4 DUP1 PUSH2 0x49 PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x4 CALLDATASIZE LT PUSH1 0x3F JUMPI PUSH1 0x0 CALLDATALOAD PUSH29 0x100000000000000000000000000000000000000000000000000000000 SWAP1 DIV PUSH4 0xFFFFFFFF AND DUP1 PUSH4 0x60FE47B1 EQ PUSH1 0x44 JUMPI JUMPDEST PUSH1 0x0 DUP1 REVERT JUMPDEST CALLVALUE DUP1 ISZERO PUSH1 0x4F JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x6C PUSH1 0x4 DUP1 CALLDATASIZE SUB DUP2 ADD SWAP1 DUP1 DUP1 CALLDATALOAD SWAP1 PUSH1 0x20 ADD SWAP1 SWAP3 SWAP2 SWAP1 POP POP POP PUSH1 0x6E JUMP JUMPDEST STOP JUMPDEST DUP1 PUSH1 0x0 DUP2 SWAP1 SSTORE POP POP JUMP STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 0x4e 0xd9 MOD DIFFICULTY 0x4c 0xc4 0xc9 0xaa 0xbd XOR EXTCODECOPY MSTORE 0xb2 0xd4 DUP7 0xdf 0xc5 0xde 0xa9 DUP1 SLT PUSH1 0xC3 CALLDATACOPY XOR 0x5d 0xad KECCAK256 0xe1 0x1f DUP2 SHL STOP 0x29</span><br></pre></td></tr></table></figure>

<p>其中下述指令集为 set 函数对应的代码，后面会解释 set 函数如何运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JUMPDEST DUP1 PUSH1 0x0 DUP2 SWAP1 SSTORE POP POP JUMP STOP</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="2">
<li><strong>部署</strong></li>
</ol>
<p>编译完后，即可在 remix 上对代码进行部署，构造参数传入 0x123:</p>
<p><img alt="img" data-src="https://static001.infoq.cn/resource/image/67/70/672172b94043bf4cc5b975f203a95270.jpg" class="lazyload"></p>
<p>部署成功后，可得到一条交易回执：</p>
<p><img alt="img" data-src="https://static001.infoq.cn/resource/image/87/ab/87213b8164635daa2680020428afa6ab.jpg" class="lazyload"></p>
<p>点开 input，可以看到具体的交易输入数据：</p>
<p><img alt="img" data-src="https://static001.infoq.cn/resource/image/5a/ce/5a1dc0efd4bb9897a5854993074e85ce.jpg" class="lazyload"></p>
<p>上面这段数据中，标黄的部分正好是前文中的合约二进制；而标紫的部分，则对应了传入的构造参数 0x123。</p>
<p>​    <strong>总结部署全过程：</strong></p>
<ul>
<li>客户端将部署请求( <em>合约二进制，构造参数</em> )作为交易的输入数据，以此构造出一笔交易</li>
</ul>
<ul>
<li>交易经过 RIP 编码，然后由发送者进行私钥签名</li>
<li>已签名的交易被推送到区块链上的节点</li>
<li>区块链节点验证交易后，存入交易池</li>
<li>轮到该节点出块时，打包交易构建区块，广播给其他节点</li>
<li>其他节点验证区块并取得共识。不同区块链可能采用不同共识算法，FISCO BCOS 中采用 PBFT 取得共识，这要求经历三阶段提交（pre-prepare，prepare, commit）</li>
<li>节点执行交易，结果就是智能合约 Demo 被创建，状态字段_state 的存储空间被分配，并被初始化为 0x123</li>
</ul>
<ol start="3">
<li><strong>执行</strong></li>
</ol>
<blockquote>
<p> 根据是否带有修饰符 view，我们可将函数分为两类：调用与交易。</p>
<p>由于在编译期就确定了view调用不会引起合约状态的变更，故对于这类函数调用，节点直接提供查询即可，无需与其他区块链节点确认。而由于交易可能引起状态变更，故会在网络间确认。</p>
</blockquote>
<p>下面将以用户调用了 set(0x10)为假设，看看具体的运行过程。</p>
<p>首先，函数 set 没有配置 view/pure 修饰符，这意味着其可能更改合约状态。所以这个调用信息会被放入一笔交易，经由交易编码、交易签名、交易推送、交易池缓存、打包出块、网络共识等过程，最终被交由各节点的 EVM 执行。</p>
<p>在 EVM 中，由 SSTORE 字节码将参数 0xa 存储到合约字段_state 中。该字节码先从栈上拿到状态字段_state 的地址与新值 0xa，随后完成实际存储。</p>
<p><img alt="img" data-src="https://static001.infoq.cn/resource/image/48/c7/48ca86e78873d4d3fd87d3ea43b5a1c7.jpg" class="lazyload"></p>
<ol start="4">
<li><strong>销毁</strong></li>
</ol>
<p>由于合约上链后就无法篡改，所以合约生命可持续到底层区块链被彻底关停。若要手动销毁合约，可通过字节码 selfdestruct。销毁合约也需要进行交易确认，在此不多作赘述。</p>
<h3 id="EVM原理"><a href="#EVM原理" class="headerlink" title="EVM原理"></a>EVM原理</h3><blockquote>
<p>EVM 是栈式虚拟机，其核心特征就是所有操作数都会被存储在栈上。</p>
</blockquote>
<p>如代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint a = 1;</span><br><span class="line">uint b = 2;</span><br><span class="line">uint c = a + b;</span><br></pre></td></tr></table></figure>

<p>这段代码经过编译后，得到的字节码如下：（此为精简代码）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PUSH1 0x1</span><br><span class="line">PUSH1 0x2</span><br><span class="line">ADD</span><br></pre></td></tr></table></figure>

<p>我们可以看到，在上述代码中，包含两个指令：PUSH1 和 ADD，它们的含义如下：</p>
<ul>
<li>PUSH1：将数据压入栈顶。</li>
<li>ADD：POP 两个栈顶元素，将它们相加，并压回栈顶。</li>
</ul>
<p>后面的内容就参照微机原理和编译系统理解了。</p>
<h3 id="存储深究"><a href="#存储深究" class="headerlink" title="存储深究"></a>存储深究</h3><p>这些变量的存储方式存在差别，下面代码表明了变量与存储方式之间的关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">contract Demo&#123;</span><br><span class="line">    //状态存储</span><br><span class="line">    uint private _state;</span><br><span class="line">    </span><br><span class="line">    function set(uint state) public &#123;</span><br><span class="line">        //栈存储</span><br><span class="line">        uint i = 0;</span><br><span class="line">        //内存存储</span><br><span class="line">        string memory str = &quot;aaa&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><strong>栈</strong></li>
</ol>
<p>栈用于存储字节码指令的操作数。在 Solidity 中，局部变量若是整型、定长字节数组等类型，就会随着指令的运行入栈、出栈。</p>
<p>例如： <code>uint i = 1;</code>  中的变量1会被push到栈顶</p>
<ol start="2">
<li><strong>内存</strong></li>
</ol>
<p>内存类似 java 中的堆，它用于储存”对象”。在 Solidity 编程中，如果一个局部变量属于变长字节数组、字符串、结构体等类型，其通常会被 memory 修饰符修饰，以表明存储在内存中。EVM是顺序分配存储空间。</p>
<ol start="3">
<li><strong>状态存储</strong></li>
</ol>
<p>状态存储用于存储合约的状态字段。</p>
<p>从模型而言，存储由多个 32 字节的存储槽构成。在前文中，我们介绍了 Demo 合约的 set 函数，里面 0x0 表示的是状态变量_state 的存储槽。所有固定长度变量会依序放到这组存储槽中。</p>
<p>对于 mapping 和数组，存储会更复杂，其自身会占据 1 槽，所包含数据则会按相应规则占据其他槽，比如 mapping 中，数据项的存储槽位由键值 k、mapping 自身槽位 p 经 keccak 计算得来。</p>
<p>从实现而言，不同的链可能采用不同实现，比较经典的是以太坊所采用的 MPT 树。由于 MPT 树性能、扩展性等问题，FISCO BCOS 放弃了这一结构，而采用了分布式存储，通过 rocksdb 或 mysql 来存储状态数据，使存储的性能、可扩展性得到提高。</p>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><ol>
<li>Solidity 源码会被编译为字节码</li>
<li>部署时，字节码会以交易为载体在网络间确认，并在节点上形成合约；</li>
<li>合约函数调用，如果是交易类型，会经过网络确认，最终由 EVM 执行。</li>
</ol>
<p>其中，EVM 是栈式虚拟机，它会读取合约的字节码并执行。</p>
<p>在执行过程中，会与栈、内存、合约存储进行交互。其中，栈用于存储普通的局部变量，这些局部变量就是字节码的操作数；内存用于存储对象，采用 length+body 进行存储，顺序分配方式进行内存分配；状态存储用于存储状态变量。</p>
<p><strong>参考资料：</strong></p>
<p><a href="https://www.infoq.cn/article/szhx9ujd6bqq3uhko4hk" target="_blank" rel="noopener">智能合约编写之 Solidity 运行原理</a></p>
<p><a href="https://solidity-cn.readthedocs.io/zh/develop/introduction-to-smart-contracts.html" target="_blank" rel="noopener">solidity官方文档</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">kid1999</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://kid1999.github.io/2021/06/20/Solidity%E5%9F%BA%E7%A1%80/">http://kid1999.github.io/2021/06/20/Solidity%E5%9F%BA%E7%A1%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://kid1999.github.io">Kid1999' Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Solidity/">Solidity    </a></div><div class="post_share"><div class="social-share" data-image="https://ae01.alicdn.com/kf/H578cfe19a3854a09ae91991ec2f13f7ey.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png"><div class="post-qr-code__desc">微信</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/06/21/Fabric%E5%9F%BA%E7%A1%80/"><img class="prev_cover lazyload" data-src="https://ae01.alicdn.com/kf/H33551ca5d3844b86a66fab8a09f02af7e.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Fabric基础</span></div></a></div><div class="next-post pull_right"><a href="/2021/06/18/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%9F%BA%E7%A1%80/"><img class="next_cover lazyload" data-src="https://ae01.alicdn.com/kf/H578cfe19a3854a09ae91991ec2f13f7ey.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>区块链基础</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'eac7c03188ca8d110797',
  clientSecret: '42d63112bb6209d8bf965ae1838947e98eb6f557',
  repo: 'kid1999.github.io',
  owner: 'kid1999',
  admin: 'kid1999',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div></div><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2021 By kid1999</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="/js/search/local-search.js"></script><script id="ribbon_piao" mobile="true" src="/js/third-party/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/ClickShowText.js"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>